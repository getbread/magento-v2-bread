<?php
/**
 * Bread BreadCheckout Hyva - Checkout Payment Method Template
 *
 * Uses existing ConfigProvider data from window.checkoutConfig.payment.breadcheckout
 *
 * @var \Magento\Framework\View\Element\Template $block
 * @var \Magento\Framework\Escaper $escaper
 */
?>

<div class="bread-payment-method"
     x-data="initBreadCheckoutPayment('breadcheckout')"
     x-init="init()"
     x-show="isActive"
     x-cloak>

    <div class="flex items-start gap-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50"
         :class="{ 'border-primary bg-primary-lighter': isSelected }"
         @click="selectMethod()">
        
        <input type="radio"
               name="payment[method]"
               id="payment_breadcheckout"
               value="breadcheckout"
               :checked="isSelected"
               class="mt-1"
               @change="selectMethod()">
        
        <label for="payment_breadcheckout" class="flex-1 cursor-pointer">
            <span class="font-medium text-gray-900" x-text="title"></span>
            <p class="text-sm text-gray-600 mt-1">
                <?= $escaper->escapeHtml(__('Pay over time with easy monthly payments')) ?>
            </p>
        </label>
    </div>

    <div x-show="isSelected" x-cloak class="mt-4 p-4 bg-gray-50 rounded-lg">
        <template x-if="isLoading">
            <div class="flex items-center justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-gray-600"><?= $escaper->escapeHtml(__('Loading payment options...')) ?></span>
            </div>
        </template>

        <div x-show="!isLoading" class="bread-checkout-btn-container">
            <div id="bread-checkout-btn-payment" class="bread-checkout-btn"></div>
            
            <input type="hidden" 
                   name="payment[bread_transaction_id]" 
                   x-model="transactionId">
            
            <template x-if="transactionId">
                <div class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <?= $escaper->escapeHtml(__('Payment authorized. You can now place your order.')) ?>
                </div>
            </template>

            <template x-if="errorMessage">
                <div class="mt-4 p-3 bg-red-100 text-red-800 rounded-lg" x-text="errorMessage"></div>
            </template>
        </div>
    </div>
</div>

<script>
    function initBreadCheckoutPayment(methodCode) {
        return {
            // State
            methodCode: methodCode,
            isActive: false,
            isSelected: false,
            isLoading: false,
            transactionId: '',
            errorMessage: '',
            wasSetup: false,
            title: '',
            
            // Config from window.checkoutConfig (populated by existing ConfigProvider)
            config: {},
            
            init() {
                // Get config from existing ConfigProvider (window.checkoutConfig.payment.breadcheckout)
                const paymentConfig = window.checkoutConfig?.payment?.[this.methodCode];
                
                if (!paymentConfig || !paymentConfig.active) {
                    this.isActive = false;
                    return;
                }
                
                this.isActive = true;
                this.config = paymentConfig;
                this.title = paymentConfig.breadConfig?.methodTitle || 'Bread Checkout';
                this.transactionId = paymentConfig.transactionId || '';
                
                window.addEventListener('payment-method-changed', (event) => {
                    this.isSelected = event.detail.method === this.methodCode;
                    if (this.isSelected && !this.wasSetup) {
                        this.setupBreadButton();
                    }
                });
            },
            
            selectMethod() {
                this.isSelected = true;
                window.dispatchEvent(new CustomEvent('payment-method-changed', {
                    detail: { method: this.methodCode }
                }));
                
                if (!this.wasSetup) {
                    this.setupBreadButton();
                }
            },
            
            async setupBreadButton() {
                this.isLoading = true;
                
                try {
                    const integrationKey = this.config.integrationKey;
                    const configClient = this.config.client || 'BREAD';
                    const sdkName = configClient === 'RBC' ? 'RBCPayPlan' : 'BreadPayments';
                    
                    // Wait for SDK to load
                    const breadSdk = await new Promise((resolve) => {
                        const check = () => {
                            if (window[sdkName]) resolve(window[sdkName]);
                            else setTimeout(check, 100);
                        };
                        check();
                    });
                    
                    if (!this.wasSetup) {
                        breadSdk.setup({ integrationKey: integrationKey });
                        
                        breadSdk.on('INSTALLMENT:APPLICATION_DECISIONED', (application) => {
                            if (application?.transactionId) {
                                this.transactionId = application.transactionId;
                            }
                        });
                        
                        breadSdk.on('INSTALLMENT:APPLICATION_CHECKOUT', (application) => {
                            if (application?.transactionId) {
                                this.transactionId = application.transactionId;
                            }
                        });
                        
                        this.wasSetup = true;
                    }
                    
                    this.registerPlacement(breadSdk);
                    
                } catch (error) {
                    console.error('Bread SDK setup failed:', error);
                    this.errorMessage = 'Unable to load payment options. Please try again.';
                }
                
                this.isLoading = false;
            },
            
            /**
             * Register placement with Bread SDK
             */
            registerPlacement(breadSdk) {
                const breadConfig = this.config.breadConfig || {};
                const items = breadConfig.items || [];
                const currencyCode = breadConfig.currencyCode || 'USD';
                const isHealthcare = this.config.isHealthcare || false;
                
                const itemsObject = [];
                let grandTotal = 0;
                
                if (!isHealthcare) {
                    items.forEach((item) => {
                        grandTotal += item.price * item.quantity;
                        itemsObject.push({
                            name: item.name,
                            quantity: item.quantity,
                            shippingCost: { value: 0, currency: currencyCode },
                            shippingDescription: '',
                            unitTax: { value: 0, currency: currencyCode },
                            unitPrice: { currency: currencyCode, value: item.price },
                            itemUrl: item.detailUrl || ''
                        });
                    });
                }
                
                const data = {
                    allowCheckout: true,
                    domID: 'bread-checkout-btn-payment',
                    order: {
                        currency: currencyCode,
                        items: itemsObject,
                        subTotal: { value: grandTotal, currency: currencyCode },
                        totalPrice: { value: grandTotal, currency: currencyCode },
                        totalDiscounts: { value: 0, currency: currencyCode },
                        totalShipping: { value: 0, currency: currencyCode },
                        totalTax: { value: 0, currency: currencyCode }
                    }
                };
                
                breadSdk.registerPlacements([data]);
                breadSdk.setInitMode('manual');
                breadSdk.init();
            }
        };
    }
</script>

<style>
    [x-cloak] { display: none !important; }
    .bread-checkout-btn { min-height: 50px; }
</style>
